<div id="switchSpin">
    <app-loading-spin *ngIf="beingSwitched"></app-loading-spin>
</div>

<div class="shell scrollbar scrollbar-primary mat-elevation-z2" *ngIf="!beingSwitched">
    <mat-card class="infoCard mat-elevation-z5">

        <mat-card-header>
            <mat-card-title>{{ client.clientNickname }}</mat-card-title>
            <mat-card-subtitle>{{ client.clientName }}</mat-card-subtitle>
        </mat-card-header>
        <mat-card-content id="headerContentContainer">
            <mat-card id="tagCard">
                <mat-card-header>
                    <mat-card-title>Client Tags</mat-card-title>
                    <mat-card-subtitle>All of the tags held by the selected client</mat-card-subtitle>
                </mat-card-header>
                <mat-card-content>
                    <app-small-loading-spin *ngIf="modyingTagRelationships || initializing"></app-small-loading-spin>

                    <!--Tag Chip list-->
                    <div id="tagChipList">
                        <mat-chip-list *ngIf="!gettingTags && !modyingTagRelationships && !initializing">
                            <mat-chip *ngFor="let tag of client.tags"
                            [selectable]="true"
                            [removable]="tagRemovable">{{tag.tagName}}<mat-icon matChipRemove (click)="removeTagFromClient(tag)" *ngIf="tagRemovable">cancel</mat-icon>
                            </mat-chip>
                        </mat-chip-list>
                    </div>
                    
                    <!--Tag Selection list-->
                    <div id="tagSelectionList">
                        <mat-divider [inset]="true" *ngIf="editingTags && !modyingTagRelationships"></mat-divider>
                        <mat-selection-list *ngIf="editingTags && !modyingTagRelationships" [(ngModel)]="selectedTags">
                            <mat-list-option *ngFor="let availableTag of availableTags" [value]="availableTag">{{availableTag.tagName}}</mat-list-option>
                        </mat-selection-list>
                    </div>

                    <!--Tag Control buttons-->
                    <div id="tagButtonContainer">
                        <button *ngIf="!editingTags && !modyingTagRelationships" class="tagButton" 
                        mat-raised-button
                        matTooltip="Add tag to the Anon"
                        [disabled]="gettingTags || initializing"
                        (click)="showAvailableTags()"
                        [matTooltipPosition]="'left'">Add Tags</button>
                    <button *ngIf="editingTags && !modyingTagRelationships" class="tagButton" 
                        mat-raised-button
                        matTooltip="Confirm Tag Selection"
                        (click)="addTagsToClient()"
                        [matTooltipPosition]="'left'">Confirm Tag Selection</button>
                    <button *ngIf="editingTags && !modyingTagRelationships" class="tagButton" 
                        mat-raised-button
                        matTooltip="Cancel Tag Action"
                        (click)="cancelTagAction()"
                        [matTooltipPosition]="'right'">Cancel</button>
                    </div>
                </mat-card-content>
            </mat-card>
        </mat-card-content>
        <app-loading-spin *ngIf="showButtonSpinner"></app-loading-spin>
        <p *ngIf="showFail">Error approving Anon</p>
        <p *ngIf="showApproveSuccess">{{ client.clientNickname }} has been approved!</p>
        <mat-card-actions *ngIf="!showButtonSpinner">
            <button mat-raised-button (click)="approveAnon()"
                *ngIf="client.clientStatus.statusDescription == 'Awaiting'">Approve</button>
            <button mat-raised-button *ngIf="client.clientStatus.statusDescription == 'Awaiting'">Deny</button>
            <button mat-raised-button>Other Options</button>
        </mat-card-actions>
    </mat-card>

    <mat-card class="infoCard mat-elevation-z5">
        <mat-card-header>
            <mat-card-title>Shipping Address</mat-card-title>
            <mat-card-subtitle>Address that Anon's would use to send something to this Anon</mat-card-subtitle>
        </mat-card-header>
        <mat-card-content>
            <p>{{ client.address.addressLineOne }}</p>
            <p>{{ client.address.addressLineTwo }}</p>
            <p>{{ client.address.city }}</p>
            <p>{{ client.address.state }}</p>
            <p>{{ client.address.postalCode }}</p>
            <p>{{ client.address.country }}</p>
        </mat-card-content>
    </mat-card>

    <!-- Response Cards -->
    <ng-container *ngIf="clientApproved">
        <mat-toolbar id="relationshipEventHeader">
            <mat-toolbar-row>
                Answers
            </mat-toolbar-row>
        </mat-toolbar>
        <div class="responseContainer">
            <div class="responseCard" *ngFor="let event of events">
                <mat-card>
                    <mat-card-header>
                        <mat-card-title>{{event.eventDescription}}</mat-card-title>
                        <mat-card-subtitle>Answers for the {{event.eventDescription}} survey</mat-card-subtitle>
                    </mat-card-header>
                    <mat-card-content>
                        <mat-accordion>
                            <!-- Expansion panels for responses -->
                            <mat-expansion-panel *ngFor="let response of responses">
                                <mat-expansion-panel-header *ngIf="event.eventTypeID == response.eventTypeID">
                                    <mat-panel-title>{{response.questionText}}</mat-panel-title>
                                    <mat-panel-description>
                                        <mat-icon>question_answer</mat-icon>
                                    </mat-panel-description>
                                </mat-expansion-panel-header>
                                <p>{{response.responseText}}</p>
                            </mat-expansion-panel>
        
                        </mat-accordion>
                    </mat-card-content>
                </mat-card>
            </div>
        </div>
    </ng-container>

    <ng-container *ngIf="clientApproved">
        <div class="relationDiv" *ngFor="let event of events">
            <mat-toolbar id="relationshipEventHeader">
                <mat-toolbar-row>
                    {{event.eventDescription}}
                </mat-toolbar-row>
            </mat-toolbar>
            <mat-card id="senderCard">
                <mat-card-header>
                    <mat-card-title>Client Senders</mat-card-title>
                    <mat-card-subtitle>People who are sending to the Anon</mat-card-subtitle>
                </mat-card-header>
                <mat-card-content>
                    <mat-accordion>
                        <mat-expansion-panel *ngFor="let sender of senders">
                            <mat-expansion-panel-header *ngIf="sender.clientEventTypeID == event.eventTypeID">
                                <mat-panel-title>{{sender.clientNickname}}</mat-panel-title>
                                <mat-panel-description>
                                    <mat-icon>card_giftcard</mat-icon>
                                </mat-panel-description>
                            </mat-expansion-panel-header>
                            <div class="expansionPanelButtonContainer">
                                <button class="expansionPanelButton" mat-raised-button
                                matTooltip="Switch to this Anon"
                                [matTooltipPosition]="'left'"
                                (click)="switchAnon(sender)">Switch</button>
                            </div>
                        </mat-expansion-panel>
                    </mat-accordion>
                </mat-card-content>
            </mat-card>
            <mat-card id="recieverCard">
                <mat-card-header>
                    <mat-card-title>Client Recievers</mat-card-title>
                    <mat-card-subtitle>People the Anon is sending to</mat-card-subtitle>
                </mat-card-header>
                <mat-card-content>
                    <mat-accordion>
                        <mat-expansion-panel *ngFor="let recipient of recipients">
                            <mat-expansion-panel-header *ngIf="recipient.clientEventTypeID == event.eventTypeID">
                                <mat-panel-title>{{recipient.clientNickname}}</mat-panel-title>
                                <mat-panel-description>
                                    <mat-icon>card_giftcard</mat-icon>
                                </mat-panel-description>
                            </mat-expansion-panel-header>
                            <div class="expansionPanelButtonContainer" *ngIf="beingRemoved">
                                <app-small-loading-spin></app-small-loading-spin>
                            </div>
                            <div class="expansionPanelButtonContainer" *ngIf="!beingRemoved">
                                <button class="expansionPanelButton" mat-raised-button
                                matTooltip="Switch to this Anon"
                                [matTooltipPosition]="'left'"
                                (click)="switchAnon(recipient)">Switch</button>

                                <button class="expansionPanelButton" mat-raised-button
                                matTooltip="Remove the anon as a recipient"
                                color="warn"
                                [matTooltipPosition]="'right'"
                                (click)="removeRecipient(recipient)">Remove</button>
                            </div>
                        </mat-expansion-panel>
                    </mat-accordion>
                </mat-card-content>
            </mat-card>
        </div>
    </ng-container>
    
    <mat-card class="infoCard mat-elevation-z5">
        <mat-card-header>
            <mat-card-title>Profile Actions</mat-card-title>
            <mat-card-subtitle>Actions that modify a client's activity</mat-card-subtitle>
        </mat-card-header>
        <mat-card-actions>
            <div class="optionDiv">
                <button mat-raised-button
                matTooltip="Send the Anon a contact message (Not implimented yet)"
                [matTooltipPosition]="'right'">Contact</button>
                <mat-card-subtitle class="optionSub">
                    <p>Send a message to the client</p>
                </mat-card-subtitle>
            </div>
            <mat-divider [inset]="true"></mat-divider>

            <!--Add recipient option-->
            <div class="optionDiv" id="recipientOptionDiv" *ngIf="clientApproved">
                <div>
                    <mat-drawer-container [ngClass]="{'recipientDrawerContainerOpen' : recipientOpen,
                                                      'recipientDrawerContainerClosed' : !recipientOpen}" autosize>
                        <mat-drawer #drawer class="recipientNav" mode="side">
                            <mat-toolbar>
                                <mat-toolbar-row *ngIf="selectedRecipientEvent.eventDescription != undefined">
                                    {{selectedRecipientEvent.eventDescription}}
                                </mat-toolbar-row>
                                <mat-toolbar-row *ngIf="selectedRecipientEvent.eventDescription == undefined">
                                    Choose an event
                                </mat-toolbar-row>
                            </mat-toolbar>

                            <!--<mat-card-subtitle id="noClientSub" *ngIf="approvedClients?.length == 0">No clients available for adding!</mat-card-subtitle>-->

                            <!-- For each event in the list of all events -->
                            <app-small-loading-spin *ngIf="showRecipientListPostingSpinner"></app-small-loading-spin>
                            <mat-selection-list #recipientList  *ngIf="!showRecipientListPostingSpinner" [(ngModel)]="selectedRecipients">
                                <mat-list-option *ngFor="let clientRecipientOption of approvedRecipientClients" [value]="clientRecipientOption">{{ clientRecipientOption.clientNickname }}</mat-list-option>
                            </mat-selection-list>
                        </mat-drawer>
                        <div
                            [ngClass]="{'recipientContentOpen' : recipientOpen,'recipientContentClosed': !recipientOpen}">
                            <mat-icon>person_add</mat-icon> 
                            <div id="toggleDiv">
                                <button mat-raised-button
                                    matTooltip="Shows the list of assignable Anon's"
                                    [matTooltipPosition]="'right'"
                                    (click)="drawer.toggle()"
                                    (click)="recipientOpen = !recipientOpen">Add reciepients</button>
                                <mat-card-subtitle class="optionSub">
                                    <p>Adds people the Anon is sending to</p>
                                </mat-card-subtitle>
                            </div>
                            <div *ngIf="recipientOpen" id="confirmationButtonsDiv">
                                <button mat-raised-button
                                    matTooltip="Confirm the selected Anon's as recipients"
                                    (click)="showRecipientListPostingSpinner = true;"
                                    (click)="addRecipientsToClient()"
                                    [matTooltipPosition]="'right'"
                                    [disabled]="selectedRecipients?.length == 0 || selectedRecipientEvent.eventTypeID == undefined || showRecipientListPostingSpinner == true">Confirm Selection
                                </button>
                            </div>
                            <div *ngIf="recipientOpen" id="eventRadioDiv">
                                <mat-radio-group aria-label="Select an event" [(ngModel)]="selectedRecipientEvent" *ngIf="recipientsAreLoaded">
                                    <mat-radio-button *ngFor="let event of events" [value]="event" (click)="getAllowedRecipientsByEvent(event)">{{ event.eventDescription }}</mat-radio-button>
                                </mat-radio-group>
                            </div>
                            <p *ngIf="addRecipientSuccess" class="success">Added recipients to
                                {{ client.clientNickname }}!</p>
                            <app-small-loading-spin *ngIf="showRecipientListPostingSpinner"></app-small-loading-spin>
                        </div>
                    </mat-drawer-container>
                </div>
            </div>
            <mat-divider [inset]="true"></mat-divider>
            
            <!--Change Nickname Card-->
            <div class="optionDiv">
                <button mat-raised-button
                    matTooltip="Change the nickname of the anon"
                    [matTooltipPosition]="'right'"
                    [disabled]="!clientNicknameFormGroup.valid"
                    (click)="changeNickname()">Change Nickname</button>
                <mat-card-subtitle class="optionSub">
                    <p>Assign the Anon a proper or different Holiday Nickname</p>
                </mat-card-subtitle>

                <app-loading-spin *ngIf="showNickSpinner"></app-loading-spin>
                <p class="success" *ngIf="showNicnameSuccess">The Nickname for {{ client.clientName }} has been successfully updated to {{ client.clientNickname }}!</p>
                <mat-form-field [formGroup]="clientNicknameFormGroup" class="mat-elevation-z2" id="nickField"
                    *ngIf="!showNickSpinner">
                    <mat-label>New Nickname</mat-label>
                    <input matInput #nicknameInput formControlName="newNickname" placeholder="Ex. Happy Camper" value="Nickname"
                        maxlength="50" minlength="2" pattern="[A-Za-z0-9 ]{2,50}" required>
                </mat-form-field>
            </div>
        </mat-card-actions>
    </mat-card>
    <!-- Good place for an ngFor all the events the client is a part of that they are joining in for -->
</div>